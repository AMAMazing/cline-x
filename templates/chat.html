<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#111',
                            800: '#1e1e1e',
                            700: '#2d2d2d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        /* Mobile Height Fix */
        .h-dvh { height: 100dvh; }
    </style>
</head>
<body class="bg-[#0A0A0A] text-gray-100 h-dvh flex flex-col font-sans selection:bg-blue-500/30 overflow-hidden">
    <!-- Background Gradients -->
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-500/5 rounded-full blur-[100px] pointer-events-none z-0"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-500/5 rounded-full blur-[100px] pointer-events-none z-0"></div>

    <!-- Header -->
    <header class="flex-shrink-0 flex justify-between items-center px-6 py-4 border-b border-gray-800 bg-[#0A0A0A]/80 backdrop-blur-md z-10">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('dashboard') }}" class="p-2 rounded-lg hover:bg-gray-800 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </a>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white truncate max-w-[60vw]">
                    {{ project_name }}
                </h1>
                <p class="text-xs text-green-400 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    Active Session
                </p>
            </div>
        </div>
    </header>

    <!-- Messages Area -->
    <main class="flex-1 overflow-y-auto p-4 z-10" id="messages-area">
        <div class="max-w-3xl mx-auto flex flex-col gap-4 min-h-full justify-end">
            <!-- Initial System Message -->
            <div class="flex justify-start">
                <div class="bg-gray-800 border border-gray-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                    <div class="text-xs text-gray-500 mb-1">System</div>
                    <div class="text-sm text-gray-200">Connected to {{ project_name }}. Ready for commands.</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <div class="flex-shrink-0 p-4 border-t border-gray-800 bg-[#0A0A0A] z-20">
        <div class="max-w-3xl mx-auto flex gap-3">
            <div class="relative flex-1">
                <textarea 
                    id="message-input" 
                    placeholder="Type a message..." 
                    class="w-full bg-[#1A1A1A] border border-gray-700 rounded-xl px-4 py-3 text-sm text-gray-100 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none h-[50px] max-h-[120px] shadow-inner transition-all"
                    rows="1"
                ></textarea>
            </div>
            <button 
                onclick="sendMessage()" 
                class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-semibold px-6 rounded-xl transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center hover:scale-105 active:scale-95 h-[50px]"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </div>

    <!-- Live Screen View Elements -->
    
    <!-- Floating Trigger Button -->
    <button 
        onclick="toggleScreenView()"
        class="fixed bottom-24 right-6 w-12 h-12 bg-gray-800 hover:bg-gray-700 text-white rounded-full shadow-lg border border-gray-600 flex items-center justify-center z-50 transition-all hover:scale-110 active:scale-95 group"
        title="View Desktop"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-blue-400 transition-colors">
            <rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>
        </svg>
    </button>

    <!-- Modal Overlay -->
    <div id="screen-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="relative w-full max-w-[90vw] h-[80vh] bg-[#111] border border-gray-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col animate-in fade-in zoom-in duration-200">
            <!-- Modal Header -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 bg-[#0A0A0A]">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-sm font-medium text-gray-300">Live Desktop View</span>
                </div>
                <button onclick="toggleScreenView()" class="p-1 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            
            <!-- Modal Content (Image) -->
            <div class="flex-1 bg-black flex items-center justify-center overflow-hidden relative group">
                 <img id="screen-img" class="max-w-full max-h-full object-contain" src="" alt="Loading screen...">
                 <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 backdrop-blur px-3 py-1 rounded-full text-xs text-white/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    Updating live...
                 </div>
            </div>
        </div>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const messagesArea = document.getElementById('messages-area');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = messagesArea.firstElementChild;
        
        let lastMessageCount = 0;

        function scrollToBottom() {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function createMessageElement(msg, isUser) {
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            // Tailwind classes for message bubbles
            bubble.className = isUser 
                ? 'bg-gradient-to-br from-blue-600 to-purple-600 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[85%] shadow-md'
                : 'bg-gray-800 border border-gray-700 text-gray-200 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%] shadow-sm';
            
            const meta = document.createElement('div');
            meta.className = `text-[10px] mb-1 ${isUser ? 'text-blue-200' : 'text-gray-500'}`;
            meta.textContent = isUser ? 'You \u2022 ' + (msg.time || '') : 'Assistant \u2022 ' + (msg.time || '');
            
            const content = document.createElement('div');
            content.className = 'text-sm whitespace-pre-wrap leading-relaxed';
            content.textContent = msg.text;
            
            bubble.appendChild(meta);
            bubble.appendChild(content);
            div.appendChild(bubble);
            return div;
        }

        function renderMessages(messages) {
            if (messages.length === lastMessageCount) return;
            lastMessageCount = messages.length;
            
            // Clear and Rebuild (Simple approach for consistency)
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                 const div = createMessageElement({text: "Connected to {{ project_name }}. Ready for commands.", time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}, false);
                 messagesContainer.appendChild(div);
            } else {
                messages.forEach(msg => {
                    const isUser = msg.role === 'user';
                    const div = createMessageElement(msg, isUser);
                    messagesContainer.appendChild(div);
                });
            }
            scrollToBottom();
        }

        async function fetchMessages() {
            try {
                const response = await fetch('/get_messages');
                if (response.ok) {
                    const messages = await response.json();
                    renderMessages(messages);
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            messageInput.value = '';
            messageInput.style.height = 'auto'; // Reset height
            
            // Optimistic UI
            const pendingMsg = {
                role: 'user',
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };
            messagesContainer.appendChild(createMessageElement(pendingMsg, true));
            scrollToBottom();

            try {
                const response = await fetch('/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ message: text }),
                });
                
                if ((await response.json()).status === 'success') {
                    fetchMessages();
                }
            } catch (error) {
                console.error(error);
                alert("Failed to send message");
            }
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Send on Enter
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Focus input
        if (window.innerWidth > 768) messageInput.focus();

        // Poll
        fetchMessages();
        setInterval(fetchMessages, 2000);
        
        // Initial scroll
        setTimeout(scrollToBottom, 100);

        // --- Live Screen View Logic ---
        let screenInterval = null;
        const screenModal = document.getElementById('screen-modal');
        const screenImg = document.getElementById('screen-img');

        function toggleScreenView() {
            const isHidden = screenModal.classList.contains('hidden');
            if (isHidden) {
                screenModal.classList.remove('hidden');
                startScreenStream();
            } else {
                screenModal.classList.add('hidden');
                stopScreenStream();
            }
        }

        function startScreenStream() {
            stopScreenStream(); // clear any existing
            refreshScreen();
            screenInterval = setInterval(refreshScreen, 1000); // 1 update per second
        }

        function stopScreenStream() {
            if (screenInterval) clearInterval(screenInterval);
            screenInterval = null;
        }

        function refreshScreen() {
            // timestamp to prevent caching
            // Using .onload to avoid flickering if possible, though simple src replace is standard for MJPEG-like behavior
            const tempImg = new Image();
            tempImg.onload = () => {
                screenImg.src = tempImg.src;
            };
            tempImg.src = '/api/screenshot?t=' + new Date().getTime();
        }
        
        // Close modal on click outside
        screenModal.addEventListener('click', (e) => {
            if (e.target === screenModal) {
                toggleScreenView();
            }
        });
    </script>
</body>
</html>
