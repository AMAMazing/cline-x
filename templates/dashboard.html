<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS Code Launcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#111',
                            800: '#1e1e1e',
                            700: '#2d2d2d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-[#0A0A0A] text-gray-100 min-h-screen font-sans selection:bg-blue-500/30">
    <!-- Background Gradients -->
    <div class="fixed top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-500/5 rounded-full blur-[100px] pointer-events-none"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-500/5 rounded-full blur-[100px] pointer-events-none"></div>

    <div class="relative z-10 container mx-auto px-6 py-8 max-w-7xl">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-10 pb-6 border-b border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                        VS Code Launcher
                    </h1>
                    <p class="text-xs text-gray-500">Local Project Manager</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="/" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm font-medium transition-colors border border-gray-700 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.295 1.473c.497.144.971.342 1.416.587l1.25-.834a1 1 0 0 1 1.262.125l1.67 1.67a1 1 0 0 1 .125 1.262l-.834 1.25c.245.445.443.919.587 1.416l1.473.294a1 1 0 0 1 .804.98v2.36a1 1 0 0 1-.804.98l-1.473.295c-.144.497-.342.971-.587 1.416l.834 1.25a1 1 0 0 1-.125 1.262l-1.67 1.67a1 1 0 0 1-1.262.125l-1.25-.834a8.36 8.36 0 0 1-1.416.587l-.294 1.473a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.295-1.473a8.36 8.36 0 0 1-1.416-.587l-1.25.834a1 1 0 0 1-1.262-.125l-1.67-1.67a1 1 0 0 1-.125-1.262l.834-1.25a8.36 8.36 0 0 1-.587-1.416l-1.473-.294A1 1 0 0 1 1 10.82V8.46a1 1 0 0 1 .804-.98l1.473-.295c.144-.497.342-.971.587-1.416l-.834-1.25a1 1 0 0 1 .125-1.262l1.67-1.67a1 1 0 0 1 1.262-.125l1.25.834c.445-.245.919-.443 1.416-.587l.294-1.473ZM13 10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" clip-rule="evenodd" />
                    </svg>
                    Settings
                </a>
            </div>
        </div>

        <!-- Search -->
        <div class="mb-12 relative max-w-2xl mx-auto">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
                </svg>
            </div>
            <input type="text" id="search-input" 
                class="w-full bg-[#111] border border-gray-800 text-gray-100 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block pl-10 p-4 shadow-xl transition-all placeholder-gray-600" 
                placeholder="Search projects...">
        </div>

        <!-- Active Windows Section -->
        <div id="active-section" class="mb-12 {% if not active_windows %}hidden{% endif %}">
            <h2 class="text-sm font-semibold text-green-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                Active Windows
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" id="active-grid">
                {% for win in active_windows %}
                    <div class="group relative bg-[#111] border border-green-900/30 hover:border-green-500/50 rounded-2xl p-6 shadow-lg hover:shadow-green-900/10 transition-all cursor-pointer flex flex-col items-center justify-center gap-3 h-40"
                         data-title="{{ win.full_title }}" 
                         onclick="focusProject(this.dataset.title)">
                        
                        {% if win.has_icon %}
                            <img class="w-10 h-10 object-contain" src="{{ url_for('get_icon', path=win.path) }}" alt="Icon">
                        {% else %}
                            <div class="text-green-400">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />
                                </svg>
                            </div>
                        {% endif %}
                        
                        <div class="text-sm font-medium text-gray-300 group-hover:text-green-400 text-center line-clamp-2 transition-colors">
                            {{ win.name }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- All Projects Section -->
        <div>
            <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">All Projects</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" id="all-projects-grid">
                {% for project in projects %}
                    <div class="project-button group relative bg-[#111] border border-gray-800 hover:border-blue-500/50 rounded-2xl p-6 shadow-lg hover:shadow-blue-900/10 transition-all cursor-pointer flex flex-col items-center justify-center gap-3 h-40"
                         data-name="{{ project.name|lower }}" 
                         data-path="{{ project.path }}" 
                         onclick="launchProject(this.dataset.path)">
                        
                        <button class="absolute top-2 right-2 p-1.5 rounded-full hover:bg-red-500/10 hover:text-red-400 text-gray-700 opacity-0 group-hover:opacity-100 transition-all z-10"
                             title="Hide Project" 
                             data-path="{{ project.path }}"
                             onclick="ignoreProject(event, this)">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>

                        {% if project.has_icon %}
                            <!-- Removed grayscale classes -->
                            <img class="w-10 h-10 object-contain transition-all duration-300" src="{{ url_for('get_icon', path=project.path) }}" alt="Icon">
                        {% else %}
                            <!-- Replaced Emoji with SVG -->
                            <div class="text-gray-600 group-hover:text-blue-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-10">
  <!-- Back of the folder (full opacity) -->
  <path d="M19.5 21a3 3 0 0 0 3-3V9a3 3 0 0 0-3-3h-5.379a.75.75 0 0 1-.53-.22L11.47 3.66A2.25 2.25 0 0 0 9.879 3H4.5a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h15Z" />
  <!-- Front of the folder (semi-transparent) -->
  <path fill-opacity="0.5" d="M1.5 10.5V18a3 3 0 0 0 3 3h15a3 3 0 0 0 3-3v-7.5H1.5Z" />
</svg>
                            </div>
                        {% endif %}
                        
                        <div class="text-sm font-medium text-gray-400 group-hover:text-white text-center line-clamp-2 transition-colors">
                            {{ project.name }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Live Screen View Elements -->
    
    <!-- Floating Trigger Button -->
    <button 
        onclick="toggleScreenView()"
        class="fixed bottom-24 right-6 w-12 h-12 bg-gray-800 hover:bg-gray-700 text-white rounded-full shadow-lg border border-gray-600 flex items-center justify-center z-50 transition-all hover:scale-110 active:scale-95 group"
        title="View Desktop"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:text-blue-400 transition-colors">
            <rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/>
        </svg>
    </button>

    <!-- Modal Overlay -->
    <div id="screen-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="relative w-full max-w-[90vw] h-[80vh] bg-[#111] border border-gray-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col animate-in fade-in zoom-in duration-200">
            <!-- Modal Header -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 bg-[#0A0A0A]">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-sm font-medium text-gray-300">Live Desktop View</span>
                </div>
                <button onclick="toggleScreenView()" class="p-1 hover:bg-gray-800 rounded-lg text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            
            <!-- Modal Content (Image) -->
            <div class="flex-1 bg-black flex items-center justify-center overflow-hidden relative group">
                 <img id="screen-img" class="max-w-full max-h-full object-contain" src="" alt="Loading screen...">
                 <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 backdrop-blur px-3 py-1 rounded-full text-xs text-white/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    Updating live...
                 </div>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <div class="text-blue-400 font-medium animate-pulse">Processing...</div>
    </div>

    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        function showProcessing() {
            document.getElementById('processing-overlay').classList.remove('hidden');
        }

        function hideProcessing() {
            document.getElementById('processing-overlay').classList.add('hidden');
        }

        // --- Search Logic ---
        document.getElementById('search-input').addEventListener('keyup', function() {
            let filter = this.value.toLowerCase();
            let buttons = document.querySelectorAll('#all-projects-grid .project-button');
            buttons.forEach(function(button) {
                let name = button.dataset.name; 
                if (name.includes(filter)) {
                    button.classList.remove('hidden');
                    button.style.display = 'flex'; // Restore flex layout
                } else {
                    button.classList.add('hidden');
                    button.style.display = 'none';
                }
            });
        });

        // --- Launch Logic ---
        async function launchProject(path) {
            try {
                showProcessing();
                const response = await fetch('/launch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ path: path }),
                });
                const data = await response.json();
                
                if(data.status === 'success') {
                    window.location.href = '/chat?project=' + encodeURIComponent(data.project_name);
                } else {
                    hideProcessing();
                    alert("Launch failed: " + data.message);
                }
            } catch (error) { 
                console.error('Error:', error);
                hideProcessing();
                alert("An error occurred while launching.");
            }
        }

        // --- Focus Logic ---
        async function focusProject(title) {
            try {
                showProcessing();
                const response = await fetch('/focus', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ title: title }),
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.location.href = '/chat?project=' + encodeURIComponent(data.project_name);
                } else {
                   hideProcessing();
                   alert("Could not focus window: " + data.message);
                }
            } catch (error) { 
                console.error('Error:', error);
                hideProcessing();
                alert("An error occurred while focusing.");
            }
        }

        // --- Ignore Logic ---
        async function ignoreProject(event, element) {
            event.stopPropagation(); 
            if(!confirm("Hide this project?")) return;
            
            const path = element.dataset.path;

            try {
                const response = await fetch('/ignore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ path: path }),
                });
                if((await response.json()).status === 'success') location.reload(); 
            } catch (error) { console.error('Error:', error); }
        }

        // --- High Rate Polling ---
        setInterval(refreshActiveWindows, 1000); 

        async function refreshActiveWindows() {
            try {
                const response = await fetch('/api/active');
                const windows = await response.json();
                
                const grid = document.getElementById('active-grid');
                const section = document.getElementById('active-section');

                if (windows.length === 0) {
                    section.classList.add('hidden');
                    grid.innerHTML = '';
                    return;
                }

                section.classList.remove('hidden');
                
                // Rebuild Grid HTML with updated SVGs
                grid.innerHTML = windows.map(win => {
                    let iconHtml = win.has_icon 
                        ? `<img class="w-10 h-10 object-contain" src="/get_icon?path=${encodeURIComponent(win.path)}" alt="Icon">` 
                        : `<div class="text-green-400"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" /></svg></div>`;
                    
                    let safeTitle = win.full_title.replace(/"/g, '"');
                    
                    return `
                    <div class="group relative bg-[#111] border border-green-900/30 hover:border-green-500/50 rounded-2xl p-6 shadow-lg hover:shadow-green-900/10 transition-all cursor-pointer flex flex-col items-center justify-center gap-3 h-40"
                         data-title="${safeTitle}" 
                         onclick="focusProject(this.dataset.title)">
                        ${iconHtml}
                        <div class="text-sm font-medium text-gray-300 group-hover:text-green-400 text-center line-clamp-2 transition-colors">
                            ${win.name}
                        </div>
                    </div>`;
                }).join('');

            } catch (e) { console.error("Polling error", e); }
        }

        // --- Live Screen View Logic ---
        let screenInterval = null;
        const screenModal = document.getElementById('screen-modal');
        const screenImg = document.getElementById('screen-img');

        function toggleScreenView() {
            const isHidden = screenModal.classList.contains('hidden');
            if (isHidden) {
                screenModal.classList.remove('hidden');
                startScreenStream();
            } else {
                screenModal.classList.add('hidden');
                stopScreenStream();
            }
        }

        function startScreenStream() {
            stopScreenStream(); // clear any existing
            refreshScreen();
            screenInterval = setInterval(refreshScreen, 1000); // 1 update per second
        }

        function stopScreenStream() {
            if (screenInterval) clearInterval(screenInterval);
            screenInterval = null;
        }

        function refreshScreen() {
            // timestamp to prevent caching
            // Using .onload to avoid flickering if possible, though simple src replace is standard for MJPEG-like behavior
            const tempImg = new Image();
            tempImg.onload = () => {
                screenImg.src = tempImg.src;
            };
            tempImg.src = '/api/screenshot?t=' + new Date().getTime();
        }
        
        // Close modal on click outside
        screenModal.addEventListener('click', (e) => {
            if (e.target === screenModal) {
                toggleScreenView();
            }
        });
    </script>
</body>
</html>
